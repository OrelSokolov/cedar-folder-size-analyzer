name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    name: Build Windows Release
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Build Release
        run: cargo build --release --verbose
      
      - name: Get version from tag
        id: version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
      
      - name: Create ZIP archive
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $zipName = "cedar-folder-size-analyzer-$version-x86_64-windows.zip"
          Compress-Archive -Path "target\release\cedar-folder-size-analyzer.exe" -DestinationPath "target\release\$zipName"
          echo "Created $zipName"
      
      - name: Build MSI installer
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è WiX
          if (!(Test-Path "wix-tools\candle.exe")) {
            Write-Error "WiX tools not found!"
            exit 1
          }
          
          # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          New-Item -ItemType Directory -Force -Path "target\wix" | Out-Null
          
          # –ö–æ–º–ø–∏–ª—è—Ü–∏—è WiX
          & ".\wix-tools\candle.exe" -nologo -arch x64 -ext WixUIExtension `
            "wix\main.wxs" `
            "-dCargoTargetBinDir=target\release" `
            "-dVersion=$version" `
            -out "target\wix\main.wixobj"
          
          if ($LASTEXITCODE -ne 0) { exit 1 }
          
          # –°–æ–∑–¥–∞–Ω–∏–µ MSI
          & ".\wix-tools\light.exe" -nologo -ext WixUIExtension -ext WixUtilExtension `
            -out "target\wix\cedar-folder-size-analyzer-$version-x86_64.msi" `
            "target\wix\main.wixobj"
          
          if ($LASTEXITCODE -ne 0) { exit 1 }
          
          echo "MSI created successfully"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: |
            target/release/cedar-folder-size-analyzer.exe
            target/release/*.zip
            target/wix/*.msi
          retention-days: 7
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/release/cedar-folder-size-analyzer.exe
            target/release/cedar-folder-size-analyzer-${{ steps.version.outputs.VERSION }}-x86_64-windows.zip
            target/wix/cedar-folder-size-analyzer-${{ steps.version.outputs.VERSION }}-x86_64.msi
          body: |
            ## üå≤ Cedar Folder Size Analyzer ${{ github.ref_name }}
            
            –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–∞–ø–æ–∫ –∏ –¥–∏—Å–∫–æ–≤ –¥–ª—è Windows.
            
            ### üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
            
            **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –°–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ MSI —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –Ω–∏–∂–µ.
            
            **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –°–∫–∞—á–∞–π—Ç–µ ZIP –∞—Ä—Ö–∏–≤ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ EXE —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é.
            
            ### ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
            
            - üìä –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤ –∏ –ø–∞–ø–æ–∫
            - üå≤ –î—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
            - üìè –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–∞–ø–æ–∫ –∏ —Ñ–∞–π–ª–æ–≤
            - ‚ö° –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å (SSD/HDD)
            - üåô –¢—ë–º–Ω–∞—è –∏ —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º—ã
            - üåç –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 6 —è–∑—ã–∫–æ–≤
            - üóëÔ∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
            - üìÇ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º Windows
            
            ### üìù Changelog
            
            –°–º. [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint:
    name: Code Quality Check
    runs-on: windows-latest
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt
      
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run cargo check
        run: cargo check --verbose
      
      - name: Run cargo clippy
        run: cargo clippy -- -D warnings
        continue-on-error: true
      
      - name: Run cargo fmt check
        run: cargo fmt -- --check
        continue-on-error: true

