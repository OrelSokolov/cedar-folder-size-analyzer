stages:
  - build
  - release

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  RUSTUP_HOME: $CI_PROJECT_DIR/.rustup

# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
.cache_template: &cache_template
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .cargo/
      - .rustup/
      - target/

# –°–±–æ—Ä–∫–∞ —Ä–µ–ª–∏–∑–Ω–æ–π –≤–µ—Ä—Å–∏–∏
build:windows:
  stage: build
  tags:
    - windows
  <<: *cache_template
  before_script:
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Rust –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    - |
      if (!(Test-Path "$env:CARGO_HOME\bin\cargo.exe")) {
        Write-Host "Installing Rust..."
        Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe
        .\rustup-init.exe -y --default-toolchain stable --profile minimal
        Remove-Item rustup-init.exe
      }
    - $env:PATH = "$env:CARGO_HOME\bin;$env:PATH"
    - rustc --version
    - cargo --version
  script:
    # –°–±–æ—Ä–∫–∞ —Ä–µ–ª–∏–∑–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    - Write-Host "Building release version..."
    - cargo build --release --verbose
    
    # –°–æ–∑–¥–∞–Ω–∏–µ ZIP –∞—Ä—Ö–∏–≤–∞ —Å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —Ñ–∞–π–ª–æ–º
    - Write-Host "Creating ZIP archive..."
    - $version = if ($env:CI_COMMIT_TAG) { $env:CI_COMMIT_TAG } else { "dev-$($env:CI_COMMIT_SHORT_SHA)" }
    - $zipName = "cedar-folder-size-analyzer-$version-x86_64.zip"
    - Compress-Archive -Path "target\release\cedar-folder-size-analyzer.exe" -DestinationPath "target\release\$zipName" -Force
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è WiX
    - Write-Host "Building MSI installer..."
    - if (!(Test-Path "wix-tools\candle.exe")) {
        Write-Error "WiX tools not found in wix-tools directory!"
        exit 1
      }
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è WiX –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
    - New-Item -ItemType Directory -Force -Path "target\wix" | Out-Null
    
    # –ö–æ–º–ø–∏–ª—è—Ü–∏—è WiX —Ñ–∞–π–ª–∞
    - |
      & ".\wix-tools\candle.exe" -nologo -arch x64 -ext WixUIExtension `
        "wix\main.wxs" `
        "-dCargoTargetBinDir=target\release" `
        "-dVersion=$version" `
        -out "target\wix\main.wixobj"
      if ($LASTEXITCODE -ne 0) {
        Write-Error "WiX candle failed!"
        exit 1
      }
    
    # –°–æ–∑–¥–∞–Ω–∏–µ MSI —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
    - |
      & ".\wix-tools\light.exe" -nologo -ext WixUIExtension -ext WixUtilExtension `
        -out "target\wix\cedar-folder-size-analyzer-$version-x86_64.msi" `
        "target\wix\main.wixobj"
      if ($LASTEXITCODE -ne 0) {
        Write-Error "WiX light failed!"
        exit 1
      }
    
    # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö
    - Write-Host "Build completed successfully!"
    - Write-Host "Artifacts:"
    - Get-ChildItem "target\release\cedar-folder-size-analyzer.exe" | Format-Table Name, Length, LastWriteTime
    - Get-ChildItem "target\release\$zipName" | Format-Table Name, Length, LastWriteTime
    - Get-ChildItem "target\wix\cedar-folder-size-analyzer-$version-x86_64.msi" | Format-Table Name, Length, LastWriteTime
  
  artifacts:
    name: "cedar-folder-size-analyzer-$CI_COMMIT_REF_NAME"
    paths:
      - target/release/cedar-folder-size-analyzer.exe
      - target/release/*.zip
      - target/wix/*.msi
    expire_in: 1 week
  
  rules:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–º–∏—Ç–æ–≤ –≤ master –∏ –¥–ª—è –≤—Å–µ—Ö —Ç–µ–≥–æ–≤
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_COMMIT_TAG

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ –¥–ª—è —Ç–µ–≥–æ–≤
release:gitlab:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  tags:
    - docker
  needs:
    - job: build:windows
      artifacts: true
  script:
    - echo "Creating GitLab release for tag $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'Cedar Folder Size Analyzer $CI_COMMIT_TAG'
    description: |
      ## üå≤ Cedar Folder Size Analyzer $CI_COMMIT_TAG
      
      –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–∞–ø–æ–∫ –∏ –¥–∏—Å–∫–æ–≤ –¥–ª—è Windows.
      
      ### üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
      
      **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:** –°–∫–∞—á–∞–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ MSI —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –Ω–∏–∂–µ.
      
      **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:** –°–∫–∞—á–∞–π—Ç–µ ZIP –∞—Ä—Ö–∏–≤ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ EXE —Ñ–∞–π–ª –Ω–∞–ø—Ä—è–º—É—é.
      
      ### ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
      
      - üìä –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–æ–≤ –∏ –ø–∞–ø–æ–∫
      - üå≤ –î—Ä–µ–≤–æ–≤–∏–¥–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
      - üìè –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–æ–≤ –ø–∞–ø–æ–∫ –∏ —Ñ–∞–π–ª–æ–≤
      - ‚ö° –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å (SSD/HDD)
      - üåô –¢—ë–º–Ω–∞—è –∏ —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º—ã
      - üåç –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 6 —è–∑—ã–∫–æ–≤
      - üóëÔ∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
      - üìÇ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º Windows
      
      ### üìù Changelog
      
      –°–º. [CHANGELOG.md](CHANGELOG.md) –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.
  artifacts:
    paths:
      - target/release/cedar-folder-size-analyzer.exe
      - target/release/*.zip
      - target/wix/*.msi
  rules:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–≥–æ–≤
    - if: $CI_COMMIT_TAG

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–º–∏—Ç–æ–≤, –∫—Ä–æ–º–µ —Ç–µ–≥–æ–≤)
lint:check:
  stage: build
  tags:
    - windows
  <<: *cache_template
  before_script:
    - $env:PATH = "$env:CARGO_HOME\bin;$env:PATH"
    - |
      if (!(Test-Path "$env:CARGO_HOME\bin\cargo.exe")) {
        Write-Host "Installing Rust..."
        Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe
        .\rustup-init.exe -y --default-toolchain stable --profile minimal
        Remove-Item rustup-init.exe
      }
    - rustup component add clippy rustfmt
  script:
    - Write-Host "Running cargo check..."
    - cargo check --verbose
    - Write-Host "Running cargo clippy..."
    - cargo clippy -- -D warnings
    - Write-Host "Running cargo fmt check..."
    - cargo fmt -- --check
  rules:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –¥–ª—è –≤–µ—Ç–æ–∫, –Ω–æ –Ω–µ –¥–ª—è —Ç–µ–≥–æ–≤
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH
  allow_failure: true

